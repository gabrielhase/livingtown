"use strict";function drawMarkers(a,b,c){if(void 0!==b.messages){for(var d={},e=0;e<b.messages.length;e++)d[e]=b.messages[e],d[e].id=e+1,d[e].clickCallback=scrollCallback;d[e+1]={type:"user",lat:c.location.lat,lng:c.location.lng,icon:"images/current-position.png"},a.markers=d}}angular.module("livingtownApp",["leaflet-directive","firebase"]).config(["$routeProvider","$httpProvider","$locationProvider",function(a,b){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/needLocation",{templateUrl:"views/location.html",controller:"LocationCtrl"}).when("/add",{templateUrl:"views/add.html",controller:"AddCtrl"}).otherwise({redirectTo:"/"}),delete b.defaults.headers.common["X-Requested-With"]}]),angular.module("livingtownApp").controller("MainCtrl",["$scope","$rootScope","$location","geolocation","mockData","angularFire","persistence",function(a,b,c,d,e,f,g){a.center={},a.markers={},a.height=$(window).height()/2-40;var h=function(c){var d="https://livingtown.firebaseio.com/messages/"+c.city+"-"+c.state,e=new Firebase(d).startAt().limit(100);f(e,b,"messages",[]).then(function(c){b.angularReset&&b.angularReset(),b.angularReset=c,b.angularFireIsRunning?drawMarkers(a,b,g):b.$watch("messages",function(){drawMarkers(a,b,g)}),b.angularFireIsRunning=!0})};a.centerLocation=function(b){a.center.lat=b.lat,a.center.lng=b.lng},a.getTimeIdentifier=function(a){var b=moment(a.date);return b.fromNow()},a.reLocate=function(){a.showSpinner=!0,d.locate({maximumAge:10,timeout:1e3}).then(function(b){a.showSpinner=!1,g.init(b),h(b),a.center.lat=b.lat,a.center.lng=b.lng},function(a){"notLocalizable"===a.type?c.path("#/needLocation"):c.path("#/needLocation")})},a.showSpinner=!0,d.locate({maximumAge:6e4,timeout:1e3}).then(function(c){a.showSpinner=!1,angular.extend(a,{center:{lat:c.lat,lng:c.lng,zoom:12},located:!0}),g.init(c),h(c),drawMarkers(a,b,g),navigator.geolocation.watchPosition(function(b){a.center.lat=b.coords.latitude,a.center.lng=b.coords.longitude},function(){console.log("error while watching device position")},{maximumAge:10,timeout:1e3})},function(a){"notLocalizable"===a.type?c.path("#/needLocation"):c.path("#/needLocation")})}]);var scrollCallback=function(a){var b=$("#marker-"+a.id),c=$("#messageStream");c.scrollTo(b,800)};angular.module("livingtownApp").controller("LocationCtrl",["$scope",function(){}]),angular.module("livingtownApp").controller("AddCtrl",["$scope","$rootScope","$location","geolocation","persistence","photo","angularFire",function(a,b,c,d,e,f,g){a.message="",a.imageSrc="",a.imageData="images/no-image.png",d.locate({maximumAge:6e4,timeout:1e3}).then(function(c){if(void 0===e.location||e.location.city!==c.city||e.location.state!==c.state){var d="https://livingtown.firebaseio.com/messages/"+c.city+"-"+c.state,f=new Firebase(d).startAt().limit(100);g(f,b,"messages",[]).then(function(a){b.angularReset&&b.angularReset(),b.angularReset=a,e.init(c)})}a.located=!0},function(a){"notLocalizable"===a.type?c.path("#/needLocation"):c.path("#/needLocation")}),a.takePhoto=function(){navigator.camera.getPicture(function(b){a.imageSrc=b;var c=new Image;c.onload=function(){$("#scaleCanvas")[0].getContext("2d").drawImage(c,0,0,140,140),a.$apply(function(){a.imageData=$("#scaleCanvas")[0].toDataURL()})},c.src=b},function(a){alert(a)},{quality:50,sourceType:navigator.camera.PictureSourceType.CAMERA,destinationType:navigator.camera.DestinationType.FILE_URI,targetWidth:140,targetHeight:140})},a.addMessage=function(){""===a.message?alert("you need to enter a message."):(b.messages.push({lat:e.location.lat,lng:e.location.lng,message:a.message,date:(new Date).getTime(),image:a.imageData}),a.message="",c.path("/"))}}]),angular.module("livingtownApp").factory("geolocation",["$rootScope","$http","$q","cordovaReady",function(a,b,c,d){var e="http://maps.googleapis.com/maps/api/geocode/json";return{locate:function(a){var b=this,d=c.defer();return b.getCurrentPosition(a).then(function(a){b.getLocationIdentifier(a.coords.latitude,a.coords.longitude).then(function(b){b.lat=a.coords.latitude,b.lng=a.coords.longitude,d.resolve(b)},function(a){d.reject({type:"locationNotFound",message:a})})},function(){d.reject({type:"notLocalizable",message:"Could not localize this device"})}),d.promise},getCurrentPosition:d(function(b,c){return navigator.geolocation.getCurrentPosition(function(b){a.$apply(function(){c.resolve(b)})},function(){a.$apply(function(){c.reject("Could not get device location. Please enable location services on your device.")})},b),c.promise}),getLocationIdentifier:function(a,d){var f=c.defer(),g=this;return b.get(e+"?latlng="+a+","+d+"&sensor=true").success(function(a){var b=g.formatLocationIdentifier(a);""!=b.error?f.reject(b.error):f.resolve(b)}).error(function(){f.reject("Could not get data about current location from Google.")}),f.promise},formatLocationIdentifier:function(a){var b="";if("OK"!==a.status)b="Could not get any address information from Google. Try again. ";else{var c=a.results[0].address_components;a.results[0].geometry;for(var d=0;d<c.length;d++){var e=c[d];if(-1!==e.types.indexOf("locality"))var f=e.long_name;else if(-1!==e.types.indexOf("administrative_area_level_1"))var g=e.short_name}"undefined"==typeof f&&(b+="Could not find a city for the given location. "),"undefined"==typeof g&&(b+="Could not find a state for the given location. ")}return{city:f,state:g,error:b}}}}]),angular.module("livingtownApp").factory("mockData",function(){var a=function(a){var b=$("#marker-"+a.id),c=$("#messageStream");c.scrollTo(b,800)};return{get:function(){return{1:{id:"1",lat:42.359935,lng:-71.057159,message:"This Festival features a parade, various performances and even a choir of kids coming all the way down from Puerto Rico. That's awesome!",clickCallback:a},2:{id:"2",lat:42.366573,lng:-71.052677,message:"St. Josephs Feast Celebration. Lots of catholics, but still fun.",clickCallback:a},3:{id:"3",lat:42.364398,lng:-71.111498,message:"This is a magic and comedy show, mostly for kids. There's a movie screening after the show.",clickCallback:a},4:{id:"4",lat:42.394976,lng:-71.122428,message:"This is a southern-style hog roast and street festival to benefit charity. Live music.",clickCallback:a}}}}}),angular.module("livingtownApp").factory("persistence",function(){return{init:function(a){this.location=a}}}),angular.module("livingtownApp").factory("photo",["$rootScope","cordovaReady",function(a,b){return{takePhoto:b(function(a,b){return navigator.camera.getPicture(function(a){b.resolve(a)},function(){b.reject("failed to take a picture")},{quality:50,sourceType:navigator.camera.PictureSourceType.CAMERA,destinationType:navigator.camera.DestinationType.FILE_URI,targetWidth:140,targetHeight:140}),b.promise})}}]),angular.module("livingtownApp").factory("cordovaReady",["$q",function(a){return function(b){var c=[],d=function(){var a=Array.prototype.slice.call(arguments);c.push(a);var b=a[a.length-1];return b.promise};return document.addEventListener("deviceready",function(){navigator.userAgent.match(/(iPhone|iPod|iPad|Android|BlackBerry)/)||(console.log("mocking camera"),navigator.camera={getPicture:function(a){return a("images/no-image.png")},PictureSourceType:{PHOTOLIBRARY:1},DestinationType:{FILE_URI:1}},navigator.geolocation.watchPosition=function(){}),c.forEach(function(a){b.apply(this,a)}),d=b},!1),function(){var b=a.defer(),c=Array.prototype.slice.call(arguments);return c.push(b),d.apply(this,c)}}}]),this.models||(this.models={}),models.Message=function(){function a(a,b,c){a.length>140&&(a=a.substring(0,140)),this.message=a,this.lat=b,this.lng=c}return a}();